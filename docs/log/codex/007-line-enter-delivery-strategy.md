# LINE(Qt) Enter未達問題の調査と戦略提案（007）

作成日: 2026-02-07
対象: ClawGate / LINE macOS (Qt, `jp.naver.line.mac`)

## 0. 結論（先に要点）
- 現状の事実だと「Enterを確実に届ける」より、**Enter依存を外してAX操作で状態遷移させる**方が成功率は高い。
- 特に「検索結果の最上位項目をAXで直接選択（AXPress/AXSelectedChildren/AXConfirm相当）」は、実現できるなら第一候補。
- メッセージ送信も同様で、送信ボタンAXPressが取れないなら **送信成功判定をUI差分で確定**しつつ複数フォールバックを段階実行する設計が必要。

## 1. なぜEnterが届かないのか（現時点の最有力）
あなたの検証結果は一貫していて、次の解釈が最も整合的。

1. `CGEvent` / `AXUIElementPostKeyboardEvent` は API return success を返しても、Qt入力コンポーネントの実受理は保証しない。
2. マウスは届いているため、アクセシビリティ権限そのものではなく「キー入力経路（TSM/IME/first responder）」で落ちている可能性が高い。
3. `setValue` はテキスト注入としては有効だが、Qt側の「キーイベント由来の状態遷移（候補確定・送信トリガ）」を代替できない。

補足:
- `CGEventSetIntegerValueField(... target process ...)` のような「PID指定で確実に配信」系は、実運用で決定打になりにくい。配信先を示せても、最終的にQt編集部品が処理する保証はない。
- `osascript` / `System Events` も同じく「frontmost appにキーを投げる」系で、本質的には同じ失敗モードを踏みやすい。

## 2. 質問1への回答: Enterを確実に届ける方法はあるか
「確実」に近づける順で現実的に並べると以下。

1. Enterを送らない（最推奨）
- 検索候補選択はAXで項目を直接操作。
- 送信も可能ならAX操作（送信UI）か、UI状態差分による送信完了確認つき代替。

2. キー送信を残す場合の候補
- `AXUIElementPostKeyboardEvent`（既試行、失敗）
- `CGEvent` の source/tap/遅延/keycode違い（既に多く失敗）
- `System Events`（既試行、失敗）

3. 低レベルAPI（IOHID系）
- 技術的には経路が変わる可能性はあるが、非公開依存・互換性・配布リスクが高く、プロダクト採用は非推奨。

実務判断:
- 既に主要キー注入経路が潰れているため、これ以上 Enter 注入に投資するROIは低い。

## 3. 質問2への回答: 検索結果をAX直接選択する案の実現性
**高い（ただしAXツリー観測が前提）**。

成立条件:
1. 検索結果の候補がAXノードとして露出している。
2. 候補ノードに `AXPress` か、選択可能属性（`AXSelected`, `AXSelectedChildren` など）がある。
3. それが無い場合でも、候補ノードの座標を取得できれば「候補中央クリック」で代替できる。

実装難易度の本質:
- Qtアプリはロール/属性が環境で変動しやすいので、固定セレクタでなくスコアリング探索が必要。

推奨探索順（設計方針）:
1. 検索欄入力後にAX再スキャン
2. サイドバー領域内の候補ノード群抽出
3. 上から1件目（Y最小）または一致度最大の候補を選択
4. `AXPress` が無ければ座標クリック

## 4. 質問3への回答: 送信ボタンが無い場合の代替
送信も「Enterを無理に通す」より、以下の構えが現実的。

1. 送信UI代替探索
- 送信ボタン候補（アイコン・空titleボタン含む）
- コンテキストメニュー送信導線（あれば）

2. キー送信フォールバックは残すが主役にしない
- Return / KeypadEnter / Cmd+Enter を段階試行
- 各試行後に必ず送信成否をUI差分で確認

3. 送信成否判定を厳密化
- 入力欄が空になった
- 最下部メッセージに本文が追加された
- 直近N件ハッシュ差分で重複誤検知防止

重要:
- 「キー送信成功したこと」ではなく「送信結果が画面に反映されたこと」を成功条件にする。

## 5. あなたの設計に対する推奨方針
今回の条件では次が最も堅い。

1. 検索ステップ
- Enter廃止
- 検索候補をAX直接選択（不可なら候補座標クリック）

2. 送信ステップ
- 送信ボタン探索を再強化（空title/iconボタン含む）
- 無ければキー送信フォールバックを試す
- ただし成功判定は必ずUI差分ベース

3. ログ
- 「どの候補をどう選択したか」「どの送信戦略が通ったか」をStepLogに構造化記録

## 6. 追加で見落としがちな論点
1. LINE側の送信キー設定（Enter / Cmd+Enter）
- 検索確定キーと送信キーの挙動が設定で変わるケースがある。

2. IME未確定状態
- 日本語変換中はEnterが「送信」ではなく「確定」に消費される。

3. Secure Input状態
- 別アプリ起因でSecure Inputが有効だと、合成キー挙動が崩れることがある。

4. ウィンドウ/モニタ座標系
- 候補クリック戦略ではRetinaスケール・複数ディスプレイ補正を必ず考慮。

## 7. 次に確認したいこと（回答歓迎）
1. 検索結果候補はAXDumpで `AXRow` / `AXStaticText` / `AXGroup` のどれで見えていますか？
2. 候補ノードに `actions`（`AXPress`等）は出ていますか？
3. 候補ノードの `frame` は安定して取得できますか？
4. 送信キー設定は Enter 固定ですか、Cmd+Enterですか？
5. IMEを英数固定にしたときもEnter未達は同じですか？
