# LINE調査方針の再整理: まずAX観測を先行する（008）

作成日: 2026-02-07
関連: `docs/log/codex/007-line-enter-delivery-strategy.md`

## 0. 結論
ユーザー指摘どおり、**計画より先に実AXツリー観測を固定手順で行う方針は正しい**。  
今回の問題は「Enter注入APIの比較」より「LINE(Qt)が実際に露出している操作可能ノードの確認」が支配的。

## 1. Q1への回答
### 「計画前にAXダンプ観察」は正しいか
- 正しい。
- 理由:
1. Enter依存の代替（候補AXPress、候補クリック、送信判定）はAXノード実在が前提。
2. Qtアプリはバージョン・表示状態でAX構造が揺れるため、推測設計は外しやすい。
3. 既にキー注入経路は多数失敗しており、次の投資先は観測品質。

## 2. Q2への回答
### AXツリーダンプの最効率手段
結論: **既存 `/v1/axdump` を主軸に、Accessibility Inspector を補助に使う**。

理由:
- `/v1/axdump` は既に実装済みで、`actions`/`settableAttributes`/`value`/`frame` が取れる。
- API経由なら再現手順を固定しやすく、ログ比較が容易。
- Inspectorはスポット確認に強いが、手順の再現性・差分比較には弱い。

手段ごとの評価:
1. `/v1/axdump`（推奨・主軸）
- 長所: 自動化しやすい、JSON差分が取れる、既存資産を活用。
- 短所: 深さ/子数制限で見切れる可能性。

2. integration-testにログ追加（補助）
- 長所: 送信フローと同じタイミングで取得可能。
- 短所: テスト通過と実動作が乖離しやすく、観測専用には重い。

3. Accessibility Inspector（補助）
- 長所: その場でフォーカス要素の属性確認が速い。
- 短所: スナップショット保存・比較が手作業。

4. 専用エンドポイント `/v1/debug/ax-tree`（将来検討）
- 長所: 深さ、起点ノード、フィルタ条件を細かく制御できる。
- 短所: 既存 `/v1/axdump` で不足が確認されるまで優先度は低い。

5. CLIツール（将来検討）
- 長所: シェル連携しやすい。
- 短所: 既存HTTPと機能重複しやすい。

## 3. Q3への回答
### `setValue` がQt内部モデルに反映されない可能性
今回の観測では、**完全に未反映である可能性は低い**。

根拠:
- あなたの既知事実として「物理Enterで送信成功（setValue後の文字列）」がある。
- これは少なくとも送信時点でLINE側が本文を取得できていることを示す。

したがって、主要問題は「文字が入らない」ではなく「送信トリガ（Enter）が入力欄に届かない/送信判定に到達しない」。

補足:
- Qtウィジェットによっては `setValue` でイベント系列が物理入力と一致しないことはある。
- ただし本件はモデル不一致より、キー経路未達の説明が強い。

「1文字ずつ打鍵すべきか」について:
- 技術的には比較対象として有効。
- ただし、既にキー注入自体が届いていない現状では、1文字打鍵方式も同系統失敗を起こすリスクが高い。

## 4. Q4への回答
### 送信ボタンが無い場合、Enter以外の送信手段はあるか
公開API前提では選択肢は限定的。

1. AXで送信相当アクションが露出していれば使う
- `AXConfirm`/`AXPress`/カスタムaction。
- ただし現時点情報では未確認。

2. 候補選択や会話遷移をEnter依存から外す
- 送信自体はEnter依存のままでも、失敗箇所を減らせる。

3. Qt内部シグナル/スロット直叩き
- 外部プロセスから安全・一般的に行う手段はほぼ無い。
- 実質はコード注入/リバースエンジニアリング領域で、保守性・法務・安全性の観点で非推奨。

4. IPC/D-Bus的経路
- macOS版LINEで公開IPCがある可能性は低く、現実的には期待薄。

結論:
- 「公開APIのみ」であれば、送信は依然としてEnter経路の信頼化が主戦場。
- ただし会話遷移をAX直接選択へ置換すると全体成功率は上げられる。

## 5. 次にやるべき観測（実装前提ではなく調査手順）
優先度順:
1. 検索前、検索文字入力直後、候補表示中、候補選択後の4状態で `/v1/axdump` を採取。
2. 各状態で以下を抜き出し比較:
- サイドバー領域ノードの `role/subrole/frame`
- 候補ノードの `actions`
- 入力欄 `AXTextArea` の `actions/settableAttributes/value`
3. 「候補ノードに押下可能actionが存在するか」を最初に判定。
4. 送信前後で入力欄 `value` とメッセージ一覧差分を確認。

## 6. 追加質問（回答歓迎）
1. `/v1/axdump` のJSONを「検索前/検索中/候補表示中」で3つ共有できますか？
2. 候補表示中に `actions` を持つノードは何個ありますか？
3. メッセージ入力欄ノードの `settableAttributes` には何が出ていますか？
4. 候補選択を手動クリックした直後のAX差分（新規/消滅ノード）を確認できますか？
