# v5: 4-Stage Pipeline Implementation

## Summary
Replaced activate/setFocused/sendEnter pattern with a 4-stage pipeline
to fix window minimization, conversation navigation failure, and message send failure.

## Root Causes (from 3-round ChatGPT+Gemini discussion, 2 sessions)

### Session 1 (pre-implementation)
- `NSRunningApplication.activate()` sends `kAEReopenApplication`, triggering LINE's toggle-minimize
- `AXFocused` only sets AX-level focus; Qt first responder not established
- `AXPostKeyboardEvent` Enter was ignored because Qt focus was incorrect

### Session 2 (debugging "windows=0" issue)
- LINE in background exposes 0 AXWindows (only AXMenuBar visible)
- `activate()` ≠ `kAEReopenApplication`: activate only foregrounds existing windows
- `activate()` called from background thread may fail silently (Main Thread required)
- `kAEReopenApplication` Apple Event = Dock click equivalent, triggers Qt window creation
- Automation (TCC Apple Events) permission may block Apple Event delivery

## Changes

### AXQuery.swift
- Added `systemFocusedElement()` — get system-wide focused element
- Added `pid(of:)` — get PID from AXUIElement
- Added `copyBoolAttribute()` — for kAXFrontmostAttribute, kAXMinimizedAttribute
- Added `windows(appElement:)` — get all windows including minimized

### AXActions.swift
- Added `poll(intervalMs:timeoutMs:condition:)` — generic condition-based polling
- Added `surface(app:window:)` — Stage 1: AX-based window surfacing (no activate)
- Added `focusForQt(_:expectedPID:)` — Stage 2: AXPressAction for Qt first responder
- Added `sendEnterVerified(pid:window:)` — Stage 4: triple-check + CGEvent Enter
- Added `hasWindowServerWindows(pid:)` — CGWindowListCopyWindowInfo diagnostic
- Added `sendReopenEvent(bundleID:)` — kAEReopenApplication Apple Event
- Added `ensureWindow(app:appElement:bundleID:)` — full window recovery cascade:
  1. Unhide if AXHidden
  2. Surface focused window
  3. Surface any window (minimized)
  4. kAEReopenApplication from Main Thread
  5. activate(options: [.activateAllWindows]) from Main Thread as last resort
- Removed `pokeInputField()`, `clickAt(point:)`, `withFocus(on:bundleIdentifier:action:)`, `postKey()`
- Kept `sendEnter(pid:)` as fallback

### AXAppWindow.swift
- Replaced `app.activate()` with `AXActions.ensureWindow()`

### LINEAdapter.swift
- `activate_line` -> `surface_line`: uses `ensureWindow()` cascade
- `open_conversation`: focusForQt -> setValue -> poll(500ms grace) -> sendEnterVerified
- `rescan_after_navigation`: condition-based polling (3s timeout, 100ms interval)
- `input_message`: focusForQt FIRST -> setValue -> poll verify value
- `send_message`: press(button) || focusForQt + sendEnterVerified + sendEnter fallback

## Test Results
- `swift build`: success (0 new warnings)
- `integration-test.sh`: **23 PASS, 1 FAIL, 0 SKIP**
  - T4.1-T4.3: SKIP -> PASS (ensureWindow fixed background window issue)
  - T5.1: FAIL (rescan_timeout) — conversation_hint="test" に一致する会話が必要
- v4 comparison: v4 was "24 PASS" only when LINE was already in foreground with chat selected
