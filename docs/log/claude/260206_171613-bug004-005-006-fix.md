# BUG-004/005/006 Fix Log

## Date: 2026-02-06 17:16

## Summary
NIO blocking fix (BUG-001/002/003) after remaining 3 bugs from integration test fixed.

## Changes

### BUG-005: EventBus deadlock (EventBus.swift)
- **Problem**: `append()` held NSLock while executing subscriber callbacks, risking deadlock with NIO event loop
- **Fix**: Release lock before executing callbacks (line 41: `lock.unlock()` before callback loop)
- **File**: `ClawGate/Core/EventBus/EventBus.swift:23-47`

### BUG-006: AX concurrent access race (BridgeRequestHandler.swift, LINEInboundWatcher.swift)
- **Problem**: LINEInboundWatcher (main thread Timer) and HTTP handlers (blockingQueue) could access AX API simultaneously
- **Fix**:
  - Extracted `BlockingWork.queue` shared enum (`BridgeRequestHandler.swift:8-12`)
  - Changed `LINEInboundWatcher.poll()` to dispatch AX work to `BlockingWork.queue` (`LINEInboundWatcher.swift:34-36`)
  - All AX access now serialized through single queue
- **Files**: `ClawGate/Core/BridgeServer/BridgeRequestHandler.swift`, `ClawGate/Adapters/LINE/LINEInboundWatcher.swift`

### BUG-004: HTTP method mismatch returns 405 (BridgeRequestHandler.swift)
- **Problem**: Wrong HTTP method on valid path returned 401 (went through auth) instead of 405
- **Fix**:
  - Added static route table (`BridgeRequestHandler.swift:17-28`)
  - Added method mismatch check before auth (`BridgeRequestHandler.swift:71-75`)
  - Added `writeMethodNotAllowed()` helper (`BridgeRequestHandler.swift:206-216`)

## Verification

| Test | Expected | Actual |
|------|----------|--------|
| `POST /v1/health` | 405 | 405 |
| `GET /v1/send` | 405 | 405 |
| `GET /v1/health` | 200 | 200 |
| `POST /v1/pair/request` (invalid) | 401 | 401 |
| `GET /v1/nonexistent` | 401 | 401 |

All tests passed.
