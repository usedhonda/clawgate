# v8: send_message フロー修正

## 日時
2026-02-07 19:46

## 問題
1. `open_conversation` で `sendSearchEnter()` (HID Enter) だけでは検索結果の行が選択されなかった
2. `send_message` で `sendButtonU` (UniversalSelector) が LINE の閉じる/最小化ボタンにマッチし、`AXActions.press()` でウインドウが閉じていた

## 原因
### 問題1: setValue + Enter だけでは不十分
- `setValue()` は AX API で値を設定するため、Qt の `textEdited()` シグナルを発火しない
- HID Enter は検索を確定するが、結果の行を自動選択しない場合がある
- 解決: HID Enter 後に AXRow を `clickAtCenter` で直接クリック

### 問題2: sendButtonU が誤マッチ
- `sendButtonU` = `{role: "AXButton", textHints: ["send"], requiredActions: ["AXPress"]}`
- L1 (textHints) はマッチしないが、L3 (Capability + Geometry) で:
  - role=AXButton → +0.2, requiredActions=AXPress → +0.15, geometryHint=nil → skip
  - score=0.35 で candidate になる
- LINE の閉じる/最小化/フルスクリーンボタンがこのスコアでマッチ
- `press()` で閉じるボタンが押され、ウインドウが閉じる

## 修正 (LINEAdapter.swift)
### open_conversation (step 5)
```diff
- AXActions.sendSearchEnter()
+ AXActions.sendSearchEnter()
+ usleep(800_000)
+ let freshNodes = AXQuery.descendants(of: rootWindow)
+ let resultRow = freshNodes.first { $0.role == "AXRow" && ($0.frame?.height ?? 0) > 40 }
+ if let row = resultRow { AXActions.clickAtCenter(row.element) }
```

### send_message
```diff
- // Try send button first
- let candidate = SelectorResolver.resolve(selector: LineSelectors.sendButtonU, ...)
- if let button = candidate, AXActions.press(button.node.element) { return true }
+ // NOTE: Do NOT try sendButtonU — it matches close/minimize buttons
```

## 検証結果
- フルフロー (sidebar → search → click row → input → sendEnter): **成功**
- ウインドウ残存: **確認済み**
- sendEnter AXPost: down=0 up=0 (success)
- AXTextArea.value="" (送信後クリア): **確認済み**
- 再現性: テスト5,6,7 すべて ok:true

## 追加修正
- CLAUDE.md: `--sign -` → `--sign "ClawGate Dev"` 全箇所修正
- CLAUDE.md: screencapture `-x` → `-x -D1` (全画面キャプチャ)
- CLAUDE.md: Self-verify ルール追加
- CLAUDE.md: Never Re-Ask ルール追加
- docs/testing.md: テストパラメータ永続化

## 残課題
- Escape 3回で LINE ウインドウが閉じる（LINE の仕様）
- 検索フィールドに前回の値が残る（クリアが必要）
- messages API がウインドウタイトル "LINE" を返す（conversation_name 不正確）
